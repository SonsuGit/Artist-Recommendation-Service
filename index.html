<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist Recommendation Service</title>
    <!-- albumArt window global -->
    <script type="text/javascript" src="https://unpkg.com/album-art"></script>
    <!-- tailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cardTemplate {
            transition: box-shadow 0.5s;
            cursor:pointer
        }
        .cardTemplate:hover {
            box-shadow: 0px 0px 5px 10px rgba(0, 0, 0, 0.2), 0 2px 4px 0 rgba(0, 0, 0, 0.15);
        }
    </style>
    
</head>
<body>
    <!-- 질문 -->
    <div class="">
        <div id="contentContainer" class="flex flex-col justify-center items-center m-5">
            <form id="initial-UI" class="flex flex-col">
                <!-- 로고 -->
                <img class="mx-auto" src="./assets/Logo.png" alt="logo">
                <!-- 인풋하는 영역 -->
                <div class="flex flex-col items-center">
                    <input type="text" id="artistInput" class="bg-[rgb(2,191,244)] text-gray-900 text-sm rounded-md focus:outline-none focus:ring-8 focus:ring-[rgb(255,64,2)]/90 block w-1/3 sm:w-2/3 p-2.5 m-5 placeholder:text-center placeholder:text-white placeholder:font-bold text-white font-bold text-center" placeholder="아티스트 입력" required>
                    <button class="bg-[rgb(2,191,244)] hover:bg-[rgb(255,64,2)]/90 text-white font-bold py-2 px-4 rounded" onclick="fetchAlbumArt()">
                        비슷한 아티스트 검색
                    </button>
                </div>
            </form>
            <!-- 추가된 로딩 표시 -->
            <div id="loadingIndicator" class="flex justify-center items-center h-10 mt-4 hidden">
                <span class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-gray-900"></span>
                <p class="ml-2">로딩 중...</p>
            </div>
            <!-- 추천 아티스트(카드 템플릿과 함께 표시되어야함) -->
            <div id="artistRecommend" class="font-bold text-3xl text-center italic hidden">
                추천 아티스트입니다.<br>사진을 누르면<br>Spotify에서 검색합니다.
            </div>
            <!-- 카드 형식의 데이터 -->
            <div id="cardContainer" class="grid grid-cols-2 justify-center items-center m-10 lg:w-2/5 hidden">
                <!-- 카드 템플릿 -->
                <template id="cardTemplate">
                    <div class="bg-[rgb(2,191,244)] rounded-lg p-4 m-2 flex flex-col items-center cardTemplate">
                        <img class="object-cover rounded-md mb-4" src="" alt="Artist Image">
                        <p class="text-center text-white text-3xl font-bold bg-[rgb(2,191,244)]/50 rounded p-1"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        let $input = document.querySelector('#artistInput');
        let $button = document.querySelector('button');
        let data = [{
            "role": "system",
            "content": "좋아하는 가수를 입력받아서 그와 유사한 가수 4명의 이름을 나열해줘. Never provide additional context. only answer in this format: name1,name2,name3,name4 "
        }];
        const url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;

        $button.addEventListener('click', async e => {
            e.preventDefault();
            if($input.value.length == 0){
                alert('아티스트명을 입력해주세요.')
            }else{
                userInputData = $input.value;
            $input.value = '';
            }
        
            data.push({
                "role": "user",
                "content": userInputData
            });
        
            const res = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
                redirect: "follow",
            });
        
            const response = await res.json();
        
            const ArtistNameList = response.choices[0].message.content.split(",");

            const cardContainer = document.getElementById('cardContainer');
            const cardTemplate = document.getElementById('cardTemplate');
        
            cardContainer.innerHTML = '';
            
            document.getElementById('initial-UI').classList.add('hidden');
            // 로딩 표시 보여주기
            document.getElementById('loadingIndicator').classList.remove('hidden');
            // 카드 템플릿 누르면 검색하여 이동하게 하는 함수
            const SEARCH_URL = 'https://open.spotify.com/search/'
            function cardClick(artistName) {
                window.open(SEARCH_URL + artistName);
            }

            // chatGPT가 보낸 아티스트 이름 리스트로 카드템플릿 추가하기
            for (const i of ArtistNameList) {
                const albumArtURL = await fetchAlbumArt(i);
                const card = cardTemplate.content.cloneNode(true);

                card.querySelector('img').src = albumArtURL;
                card.querySelector('p').textContent = i;
                card.querySelector('img').addEventListener("click", () => cardClick(i)); // 클릭 이벤트 리스너 추가
                card.querySelector('p').addEventListener("click", () => cardClick(i)); // 클릭 이벤트 리스너 추가

                cardContainer.appendChild(card);
            }
        
            console.log(response.choices[0].message.content)
            // 로딩 표시 숨기기
            document.getElementById('loadingIndicator').classList.add('hidden');
            // 카드 컨테이너와 추천한다는 문구 보이기
            document.getElementById('artistRecommend').classList.remove('hidden');
            document.getElementById('cardContainer').classList.remove('hidden');
        });


        // https://github.com/lacymorrow/album-art
        async function fetchAlbumArt(artistName) {
            try {
                const response = await albumArt(artistName);
                return response;
            } catch (error) {
                console.error(error);
            }
        }
    </script>
</body>
</html>
